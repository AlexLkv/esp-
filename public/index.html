<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Комната для ESP32-C3</title>
</head>
<body>
  <h1>Подключение ESP32-C3 по Bluetooth</h1>
  <button id="connect">Подключиться к ESP32-C3</button>
  <button id="press">Нажать кнопку</button>

  <!-- Socket.IO -->
  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();

    let device, server, service, characteristic;

    document.getElementById('connect').addEventListener('click', async () => {
      try {
        console.log('Запрос устройства...');
        device = await navigator.bluetooth.requestDevice({
          // Для отладки можно использовать acceptAllDevices:
          // acceptAllDevices: true,
          // optionalServices: ['00001234-0000-1000-8000-00805f9b34fb']
          filters: [{ services: ['your_service_uuid'] }]
        });
        console.log('Устройство выбрано:', device);

        console.log('Подключение к GATT серверу...');
        server = await device.gatt.connect();
        console.log('GATT сервер подключен');

        console.log('Получение сервиса...');
        service = await server.getPrimaryService('your_service_uuid');
        console.log('Сервис получен');

        console.log('Получение характеристики...');
        characteristic = await service.getCharacteristic('your_characteristic_uuid');
        console.log('Характеристика получена, подключение завершено');
      } catch (error) {
        console.error('Ошибка подключения Bluetooth:', error);
      }
    });

    document.getElementById('press').addEventListener('click', async () => {
      socket.emit('buttonPress');
      if (characteristic) {
        try {
          await characteristic.writeValue(new Uint8Array([1]));
          console.log('Команда отправлена на локальный ESP32-C3');
        } catch (error) {
          console.error('Ошибка при отправке команды на ESP32-C3:', error);
        }
      }
    });

    socket.on('toggleLED', async () => {
      if (characteristic) {
        try {
          await characteristic.writeValue(new Uint8Array([1]));
          console.log('Удалённый светодиод включён');
        } catch (error) {
          console.error('Ошибка при переключении светодиода на удалённом ESP32-C3:', error);
        }
      } else {
        console.warn('Bluetooth-устройство не подключено');
      }
    });
  </script>
</body>
</html>
